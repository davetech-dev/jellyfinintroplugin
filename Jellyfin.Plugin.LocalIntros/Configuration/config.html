<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Intros</title>
</head>
<body>
    <div id="configPage" data-role="page" class="page type-interior pluginPage" data-require="emby-input,emby-button,emby-select,emby-checkbox">
        <div data-role="content">
            <div class="content-primary">
                <form id="configForm">
                    <p>Only videos from configured local storage are used. Some are available at <a is="emby-linkbutton" class="button-link emby-button" target="_blank" href="https://prerolls.video">the prerolls discord.</a>.</p>
                    <p>This was forked from <a is="emby-linkbutton" class="button-link emby-button" target="_blank" href="https://github.com/dkanada">dkanada</a>'s preroll plugin.</p>
                    <div class="inputContainer">
                        <label class="inputLabel inputLabelUnfocused" for="local">Local Source</label>
                        <input id="local" is="emby-input" placeholder="/media/intros" />
                        <div class="fieldDescription">Location of intro videos</div>
                    </div>
                    <div class="inputContainer">
                        <button id="loadVideosBtn" is="emby-button" type="button" class="raised button-submit block emby-button">
                            <span>Load Videos</span>
                        </button>
                        
                        <button id="clearVideosBtn" is="emby-button" type="button" class="raised button-submit block emby-button">
                            <span>Clean Intros (if you used old plugin)</span>
                        </button>
                        
                    </div>
                    <div class="inputContainer">
                        <label class="inputLabel inputLabelUnfocused" for="ruleSelection">Rule Type</label>
                        <select id="ruleSelection" is="emby-select">
                            <option value="default">Default</option>
                            <option value="tag">Tag</option>
                            <option value="genre">Genre</option>
                            <option value="studio">Studio</option>
                            <option value="currentDate">Current Date</option>
                        </select>
                        <div class="fieldDescription">Which kind of rule to add.</div>
                    </div>
                    <div class="inputContainer" id="tagSection">
                        <label class="inputLabel inputLabelUnfocused" for="tagSelection">Tag</label>
                        <input id="tagSelection" is="emby-input" type="text" />
                        <div class="fieldDescription">Tag to use for intros</div>
                    </div>
                    <div class="inputContainer" id="genreSection">
                        <label class="inputLabel inputLabelUnfocused" for="genreSelection">Genre</label>
                        <select id="genreSelection" is="emby-select">
                        </select>
                        <div class="fieldDescription">Genre to use for intros</div>
                    </div>
                    <div class="inputContainer" id="studioSection">
                        <label class="inputLabel inputLabelUnfocused" for="studioSelection">Studio</label>
                        <select id="studioSelection" is="emby-select">
                        </select>
                        <div class="fieldDescription">Studio to use for intros</div>
                    </div>
                    <div class="inputContainer" id="currentDateSection">
                        <label class="inputLabel inputLabelUnfocused" for="currentDateStart">Start Date</label>
                        <input id="currentDateStart" is="emby-input" type="date">
                        </input>
                        <div class="fieldDescription">Start Date for intros</div>
                        <label class="inputLabel inputLabelUnfocused" for="currentDateEnd">End Date</label>
                        <input id="currentDateEnd" is="emby-input" type="date">
                        </input>
                        <div class="fieldDescription">End Date for intros</div>
                    </div>
                    <div class="inputContainer">
                        <label class="inputLabel inputLabelUnfocused" for="videoSelection">Intro</label>
                        <select id="videoSelection" is="emby-select">
                        </select>
                        <div class="fieldDescription">Video to use for intros</div>
                    </div>
                    <div class="inputContainer" id="prevalenceSection">
                        <label class="inputLabel inputLabelUnfocused" for="rulePrevalence">Prevalence</label>
                        <input id="rulePrevalence" is="emby-input" type="number" value="1" min="1" name="rulePrevalence" />
                        <div class="fieldDescription">How likely a video is to play <em>if</em> the rule applies. (16 is 8 times as likely as 2) </div>
                    </div>
                    <div class="inputContainer" id="precedenceSection">
                        <label class="inputLabel inputLabelUnfocused" for="rulePrecedence">Precedence</label>
                        <input id="rulePrecedence" is="emby-input" type="number" value="1" min="1" name="rulePrecedence" />
                        <div class="fieldDescription">How important is the rule. If multiple rules both apply, only the ones with the highest equal precendence will be used for calculations.</div>
                    </div>
                    
                    <div class="inputContainer">
                        <button id="addRuleBtn" is="emby-button" type="button" class="raised button-submit block emby-button">
                            <span>Add</span>
                        </button>
                    </div>
                    <div class="inputContainer" id="addAllSection">
                        <button id="addAllBtn" is="emby-button" type="button" class="raised button-submit block emby-button">
                            <span>Add All</span>
                        </button>
                    </div>


                    <table class="detailTable">
                        <caption class="clipForScreenReader">List of the currently enabled API keys</caption>
                        <thead>
                            <tr>
                                <th scope="col" class="detailTableHeaderCell">
                                    Rule
                                </th>
                                <th scope="col" class="detailTableHeaderCell">
                                    Intro
                                </th>
                                <th scope="col" class="detailTableHeaderCell">
                                    Precedence
                                </th>
                                <th scope="col" class="detailTableHeaderCell">
                                    Prevalence
                                </th>
                                <th scope="col" class="detailTableHeaderCell">
                                </th>
                            </tr>
                        </thead>
                        <tbody class="resultBody" id="ruleTable">
                            <!-- <tr class="detailTableBodyRow detailTableBodyRow-shaded">
                                <td class="detailTableBodyCell">
                                    <button type="button" is="emby-button" data-token="b3d721993ac24ee6a52b0d842d9b3d9f" class="raised raised-mini btnRevoke emby-button" data-mini="true" title="Revoke" style="margin:0;">
                                        Remove
                                    </button>
                                </td>
                                <td class="detailTableBodyCell" style="vertical-align:middle;">
                                    Tag
                                </td>
                                <td class="detailTableBodyCell" style="vertical-align:middle;">
                                    Main
                                </td>
                                <td class="detailTableBodyCell" style="vertical-align:middle;">
                                    1
                                </td>
                                <td class="detailTableBodyCell" style="vertical-align:middle;">
                                    50
                                </td>
                            </tr> -->
                        </tbody>
                    </table>

                    <div>
                        <button is="emby-button" type="submit" class="raised button-submit block emby-button">
                            <span>Save</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <script type="text/javascript">
            (() => {
                var plugin = {
                    guid: '07d86795-01f2-4d22-b174-cdc6056c3e7c'
                };
                
                var cleanDate = str => str.split('T')[0];

                var localIntroConfig = {
                    Local: "",
                    DetectedLocalVideos: [],
                    DefaultLocalVideos: [],
                    TagIntros: [], 
                    GenreIntros: [],
                    StudioIntros: []
                };

                var loadPage = () => {
                    Dashboard.showLoadingMsg();

                    //Tags? There's no canonical list of tags without searching *every* item in the database. Just *_NO_*.

                    //Load Genres from Server.

                    Promise.all([
                        ApiClient.getGenres(ApiClient.getCurrentUserId()), 
                        ApiClient.getStudios(ApiClient.getCurrentUserId()),
                        ApiClient.getPluginConfiguration(plugin.guid)
                    ]).then(([genreItems, studioItems, config]) => {
                        localIntroConfig = config;


                        $('#local').val(config.Local);
                        
                        var parentCheckboxList = $('#videoSelection');
                        parentCheckboxList.empty();
                        for (var detectedVideo of config.DetectedLocalVideos) {
                            var newItem = $("<option>");
                            newItem.attr("value", detectedVideo.ItemId);
                            newItem.text(detectedVideo.Name);
                            parentCheckboxList.append(newItem);
                        }

                        var genres = genreItems.Items;
                        var genreSelect = $('#genreSelection');
                        genreSelect.empty();
                        for (var genre of genres) {
                            var newItem = $("<option>");
                            newItem.attr("value", genre.Name);
                            newItem.text(genre.Name);
                            genreSelect.append(newItem);
                        }

                        var studioItems = studioItems.Items;
                        var studioSelect = $('#studioSelection');
                        studioSelect.empty();
                        for (var studio of studioItems) {
                            var newItem = $("<option>");
                            newItem.attr("value", studio.Name);
                            newItem.text(studio.Name);
                            studioSelect.append(newItem);
                        }

                        updateUi();

                        Dashboard.hideLoadingMsg();
                    });
                };

                var loadVideos = () => {
                    let url = ApiClient.getUrl('LocalIntros/LoadIntros');
                    let data = {};
                    ApiClient.ajax({ type: 'POST', url, data, contentType: 'application/json' }).then(() => {loadPage()}).catch(ev => alert(ev));
                }

                var clearIntros = () => {
                    let url = ApiClient.getUrl('LocalIntros/ClearIntros');
                    let data = {};
                    ApiClient.ajax({ type: 'POST', url, data, contentType: 'application/json' }).then(() => {loadPage()}).catch(ev => alert(ev));
                }

                var addTagIntroRule = (introId, precedence, prevalence) => 
                {
                    var tagRule = {
                        IntroId: introId,
                        TagName: $('#tagSelection').val(),
                        Precedence: precedence,
                        Prevalence: prevalence
                    };
                    localIntroConfig.TagIntros.push(tagRule);
                };
                var addGenreIntroRule = (introId, precedence, prevalence) => 
                {
                    var genreRule = {
                        IntroId: introId,
                        GenreName: $('#genreSelection').val(),
                        Precedence: precedence,
                        Prevalence: prevalence
                    };
                    localIntroConfig.GenreIntros.push(genreRule);
                };
                var addStudioIntroRule = (introId, precedence, prevalence) => 
                {
                    var studioRule = {
                        IntroId: introId,
                        StudioName: $('#studioSelection').val(),
                        Precedence: precedence,
                        Prevalence: prevalence
                    };
                    localIntroConfig.StudioIntros.push(studioRule);
                };
                var addCurrentDateIntroRule = (introId, precedence, prevalence) => 
                {
                    var currentDateRule = {
                        IntroId: introId,
                        DateStart: $('#currentDateStart').val(),
                        DateEnd: $('#currentDateEnd').val(),
                        Precedence: precedence,
                        Prevalence: prevalence
                    };
                    localIntroConfig.CurrentDateIntros.push(currentDateRule);
                };
                var addDefaultIntroRule = introId => 
                {
                    if (localIntroConfig.DefaultLocalVideos.includes(introId) == false) {
                        localIntroConfig.DefaultLocalVideos.push(introId);
                    }
                };

                var saveChanges = () => 
                    ApiClient.updatePluginConfiguration(plugin.guid, localIntroConfig);

                var updateUi = () => {


                    var ruleType = $('#ruleSelection').val();
                    switch (ruleType) {
                        case 'tag':
                            $('#tagSection').show();
                            $('#genreSection').hide();
                            $('#studioSection').hide();
                            $('#currentDateSection').hide();
                            $('#prevalenceSection').show();
                            $('#precedenceSection').show();
                            $('#addAllSection').hide();
                            break;
                        case 'genre':
                            $('#tagSection').hide();
                            $('#genreSection').show();
                            $('#studioSection').hide();
                            $('#currentDateSection').hide();
                            $('#prevalenceSection').show();
                            $('#precedenceSection').show();
                            $('#addAllSection').hide();
                            break;
                        case 'studio':
                            $('#tagSection').hide();
                            $('#genreSection').hide();
                            $('#studioSection').show();
                            $('#currentDateSection').hide();
                            $('#prevalenceSection').show();
                            $('#precedenceSection').show();
                            $('#addAllSection').hide();
                            break;
                        case 'currentDate':
                            $('#tagSection').hide();
                            $('#genreSection').hide();
                            $('#studioSection').hide();
                            $('#currentDateSection').show();
                            $('#prevalenceSection').show();
                            $('#precedenceSection').show();
                            $('#addAllSection').hide();
                            break;
                        case 'default':
                            $('#tagSection').hide();
                            $('#genreSection').hide();
                            $('#studioSection').hide();
                            $('#currentDateSection').hide();
                            $('#prevalenceSection').hide();
                            $('#precedenceSection').hide();
                            $('#addAllSection').show();
                            break;
                    }

                    var ruleTableBody = $('#ruleTable');
                    ruleTableBody.empty();

                    console.log(localIntroConfig);

                    var getName = (id) => { 
                        if (id === null) return "None";
                        for (var video of localIntroConfig.DetectedLocalVideos) {
                            if (video.ItemId === id) return video.Name;
                        }
                        return "Unknown";
                    }

                    var tagR = localIntroConfig.TagIntros.map((tag,i) => ({ type: 'Tag', name: tag.TagName, precedence: tag.Precedence, prevalence: tag.Prevalence, introName: getName(tag.IntroId), removeMe: () => {
                        localIntroConfig.TagIntros.splice(i, 1);
                        updateUi();
                    } }));
                    var genreR = localIntroConfig.GenreIntros.map((genre,i) => ({ type: 'Genre', name: genre.GenreName, precedence: genre.Precedence, prevalence: genre.Prevalence, introName: getName(genre.IntroId), removeMe: () => {
                        localIntroConfig.GenreIntros.splice(i, 1);
                        updateUi();
                    } }));
                    var studioR = localIntroConfig.StudioIntros.map((studio,i) => ({ type: 'Studio', name: studio.StudioName, precedence: studio.Precedence, prevalence: studio.Prevalence, introName: getName(studio.IntroId), removeMe: () => {
                        localIntroConfig.StudioIntros.splice(i, 1);
                        updateUi();
                    } }));

                    var currentDateR = localIntroConfig.CurrentDateIntros.map((currentDate,i) => 
                    ({ 
                        type: 'Current Date', 
                        name: cleanDate(currentDate.DateStart) + " - " + cleanDate(currentDate.DateEnd), 
                        precedence: currentDate.Precedence, 
                        prevalence: currentDate.Prevalence, 
                        introName: getName(currentDate.IntroId), 
                        removeMe: () => {
                            localIntroConfig.CurrentDateIntros.splice(i, 1);
                            updateUi();
                        }
                    })
                    );

                    var defaults = localIntroConfig.DefaultLocalVideos.map((introId,i) => ({ type: 'Default', name: '', precedence: 0, prevalence: 0, introName: getName (introId), removeMe: () => {
                        localIntroConfig.DefaultLocalVideos.splice(i, 1);
                        updateUi();
                    } }));
                    //higher precedence first, so sort descending
                    tagR.concat(genreR).concat(studioR).concat(currentDateR).sort((a,b) => a.precedence < b.precedence ? 1 : -1).concat(defaults).forEach(rule => {
                        var row = $('<tr>').addClass('detailTableBodyRow').addClass('detailTableBodyRow-shaded').append(
                                        $('<td>').addClass('detailTableBodyCell').text(rule.type + ": " + rule.name)
                                        ).append(
                                        $('<td>').addClass('detailTableBodyCell').text(rule.introName)
                                        ).append(
                                        $('<td>').addClass('detailTableBodyCell').text(rule.precedence)
                                        ).append(
                                        $('<td>').addClass('detailTableBodyCell').text(rule.prevalence)
                                        ).append(
                                        $('<td>').addClass('detailTableBodyCell').append(
                                            $('<button>')
                                                .addClass('raised button-submit block emby-button')
                                                .text('-')
                                                .click(ev => rule.removeMe()))
                                        );
                        ruleTableBody.append(row);
                    });

                };

                document.querySelector('#configPage').addEventListener('pageshow', () => loadPage());

                $('#ruleSelection').change(ev => {
                    updateUi();
                });

                $('#loadVideosBtn').click(ev => {
                    saveChanges().then(() => loadVideos());
                });
                
                $('#clearVideosBtn').click(async ev => {
                    await saveChanges();
                    await clearIntros();
                    await loadVideos();
                });

                $('#local').change(ev => {
                    localIntroConfig.Local = $('#local').val();
                });

                $('#addAllBtn').click(ev => {
                    
                    for (var video of localIntroConfig.DetectedLocalVideos) {
                        addDefaultIntroRule(video.ItemId);
                    }
                    updateUi();
                })

                $('#addRuleBtn').click(ev => {
                    var ruleType = $('#ruleSelection').val();
                    var introId = $('#videoSelection').val();
                    var rulePrecedence = $('#rulePrecedence').val() || 1;
                    var rulePrevalence = $('#rulePrevalence').val() || 1;
                    switch(ruleType) {
                        case 'tag':
                            addTagIntroRule(introId, rulePrecedence, rulePrevalence);
                            break;
                        case 'genre':
                            addGenreIntroRule(introId, rulePrecedence, rulePrevalence);
                            break;
                        case 'studio':
                            addStudioIntroRule(introId, rulePrecedence, rulePrevalence);
                            break;
                        case 'currentDate':
                            addCurrentDateIntroRule(introId, rulePrecedence, rulePrevalence);
                            break;
                        default:
                            addDefaultIntroRule(introId);
                            break;
                    }
                    updateUi();
                });

                document.querySelector('#configForm').addEventListener('submit', function (event) {
                    Dashboard.showLoadingMsg();

                    saveChanges().then(function (result) {
                        Dashboard.processPluginConfigurationUpdateResult(result);
                    });;

                    event.preventDefault();
                    return false;
                });
            })();
            
        </script>
    </div>
</body>
</html>
